name: Deploy Frontend App to VPS

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      # ✅ Inject production env for CRA build
      - name: Create .env.production
        run: |
          echo "REACT_APP_API_URL=${{ secrets.REACT_APP_API_URL }}" > .env.production

      - name: Build React app
        run: npm run build

      # ✅ Prepare dirs on VPS
      - name: Prepare VPS directories
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          timeout: 120s
          command_timeout: 10m
          use_insecure_cipher: false
          script: |
            set -e
            TARGET="${{ secrets.TARGET_DIR }}"
            RELEASES="$TARGET/_releases"
            TS="$(date +%Y%m%d-%H%M%S)"
            NEW="$RELEASES/$TS"

            mkdir -p "$RELEASES"
            mkdir -p "$NEW"
            echo "New release dir: $NEW"

      # ✅ Upload build folder into latest release dir
      - name: Upload build to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          timeout: 180s
          command_timeout: 20m
          use_insecure_cipher: false
          source: "build/**"
          target: "${{ secrets.TARGET_DIR }}/_incoming"
          overwrite: true

      # ✅ Activate: move build contents to a new release, then point "current" to it (atomic)
      - name: Activate release (atomic)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          timeout: 120s
          command_timeout: 10m
          use_insecure_cipher: false
          script: |
            set -e
            TARGET="${{ secrets.TARGET_DIR }}"
            RELEASES="$TARGET/_releases"
            INCOMING="$TARGET/_incoming/build"
            TS="$(date +%Y%m%d-%H%M%S)"
            NEW="$RELEASES/$TS"
            CURRENT="$TARGET/current"
            BUILD_ROOT="$TARGET/build"

            if [ ! -d "$INCOMING" ]; then
              echo "ERROR: Incoming build not found at $INCOMING"
              ls -la "$TARGET/_incoming" || true
              exit 1
            fi

            mkdir -p "$NEW"
            cp -a "$INCOMING"/. "$NEW"/

            # atomic switch
            rm -f "$CURRENT"
            ln -s "$NEW" "$CURRENT"

            # Keep nginx root in sync.
            # Your nginx config uses: root /var/www/root/build;
            # This makes $TARGET/build always point at the latest release.
            if [ -e "$BUILD_ROOT" ] || [ -L "$BUILD_ROOT" ]; then
              rm -rf "$BUILD_ROOT"
            fi
            ln -s "$NEW" "$BUILD_ROOT"

            # optional permissions
            chmod -R 755 "$NEW"

            # cleanup incoming
            rm -rf "$TARGET/_incoming"

            echo "Current -> $(readlink $CURRENT)"
            echo "BuildRoot -> $(readlink $BUILD_ROOT)"
            ls -la "$CURRENT" | head -n 50
